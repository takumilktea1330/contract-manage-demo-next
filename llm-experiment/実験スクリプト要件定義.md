# PDF データ抽出 LLM 比較実験 - Pythonスクリプト要件定義

## 1. 概要

本ドキュメントは、不動産賃貸借契約書PDFから構造化データを抽出するLLM比較実験を実行するためのPythonスクリプトに必要な要素と機能を定義する。

---

## 2. システムアーキテクチャ

```
├── config/
│   ├── api_keys.json          # APIキー管理（.gitignore対象）
│   ├── pricing.json           # トークン単価設定
│   └── schema.json            # 目標JSONスキーマ
├── prompts/
│   └── system_prompt.txt      # システムプロンプト
├── data/
│   ├── input/                 # 入力PDF格納
│   │   ├── pdf_01.pdf
│   │   └── ...
│   └── golden/                # 正解データ（Golden Standard）
│       ├── pdf_01.json
│       └── ...
├── output/
│   ├── extracted/             # LLM抽出結果JSON
│   │   ├── gemini_pdf_01.json
│   │   └── ...
│   ├── logs/                  # 実行ログ
│   └── results/               # 評価結果
│       ├── metrics.csv
│       └── summary.json
├── src/
│   ├── api_clients/           # API連携モジュール
│   │   ├── gemini_client.py
│   │   ├── gpt_client.py
│   │   ├── claude_client.py
│   │   └── azure_client.py
│   ├── processors/            # 処理モジュール
│   │   ├── pdf_processor.py
│   │   └── image_converter.py
│   ├── evaluators/            # 評価モジュール
│   │   ├── schema_validator.py
│   │   ├── accuracy_calculator.py
│   │   └── cost_calculator.py
│   ├── utils/                 # ユーティリティ
│   │   ├── logger.py
│   │   └── config_loader.py
│   └── main.py                # メイン実行スクリプト
├── requirements.txt
└── README.md
```

---

## 3. 必要な機能モジュール

### 3.1. API連携モジュール (`api_clients/`)

各LLMサービスとの通信を担当する。

#### 共通インターフェース
```python
class BaseLLMClient:
    def __init__(self, api_key: str, model_name: str)
    def extract_data(self, pdf_path: str, system_prompt: str, schema: dict) -> dict
    def get_token_usage(self) -> dict  # {input_tokens, output_tokens}
    def get_response_time(self) -> float
    def calculate_cost(self) -> float
```

#### 実装が必要なクライアント
1. **GeminiClient** (`gemini_client.py`)
   - Google Generative AI SDK使用
   - Gemini Pro 2.5とFlash 2.5の切り替え対応
   - マルチモーダル入力（PDF→画像変換後の入力）

2. **GPTClient** (`gpt_client.py`)
   - OpenAI API使用
   - GPT-4oのマルチモーダル機能使用
   - Vision APIでPDF画像を処理

3. **ClaudeClient** (`claude_client.py`)
   - Anthropic API使用
   - Claude 3 OpusとSonnetの切り替え対応
   - Vision機能でPDF画像を処理

4. **AzureDocumentClient** (`azure_client.py`)
   - Azure Document Intelligence (Form Recognizer) 使用
   - カスタムモデルまたはプリビルトモデル
   - 結果を目標JSONスキーマに変換

#### 必要な機能
- API認証とエラーハンドリング
- レート制限対応（リトライ機能）
- タイムアウト設定
- トークン数の取得
- レスポンスタイムの計測
- エラーログの記録

---

### 3.2. PDF処理モジュール (`processors/`)

#### PDFProcessor (`pdf_processor.py`)
```python
class PDFProcessor:
    def load_pdf(self, pdf_path: str) -> bytes
    def get_page_count(self, pdf_path: str) -> int
    def validate_pdf(self, pdf_path: str) -> bool
```

#### ImageConverter (`image_converter.py`)
```python
class ImageConverter:
    def pdf_to_images(self, pdf_path: str, dpi: int = 200) -> List[Image]
    def encode_image_base64(self, image: Image) -> str
    def optimize_image_size(self, image: Image, max_size_mb: float) -> Image
```

**必要なライブラリ:**
- `pdf2image` (Poppler依存)
- `Pillow`
- `PyPDF2`

---

### 3.3. 評価モジュール (`evaluators/`)

#### SchemaValidator (`schema_validator.py`)
```python
class SchemaValidator:
    def __init__(self, schema_path: str)
    def validate(self, extracted_json: dict) -> tuple[bool, List[str]]
    def calculate_conformance_rate(self, results: List[tuple]) -> float
```

**必要なライブラリ:**
- `jsonschema`

#### AccuracyCalculator (`accuracy_calculator.py`)
```python
class AccuracyCalculator:
    def __init__(self, golden_data: dict, extracted_data: dict)

    def calculate_field_accuracy(self) -> float
        # 項目正答率: 正しく抽出されたフィールドの割合

    def calculate_f1_score(self) -> float
        # F1スコア: キー・バリューペア単位での適合率と再現率

    def calculate_exact_match(self) -> bool
        # 完全一致率: JSON文字列としての完全一致

    def compare_nested_dict(self, golden: dict, extracted: dict) -> dict
        # ネストされた辞書の比較

    def get_detailed_diff(self) -> dict
        # 差分の詳細（デバッグ用）
```

**評価ロジック:**
- 再帰的なJSON比較
- 型の厳密なチェック
- 日付形式の検証（YYYY-MM-DD）
- 数値の許容誤差設定
- 配列要素の順序非依存比較（オプション）

#### CostCalculator (`cost_calculator.py`)
```python
class CostCalculator:
    def __init__(self, pricing_config: dict)

    def calculate_cost(self, model: str, input_tokens: int, output_tokens: int) -> float
        # トークン数とトークン単価からコスト計算（円換算）

    def calculate_average_cost(self, results: List[dict]) -> float
        # 平均コスト/PDFの算出

    def get_cost_breakdown(self) -> dict
        # 入力/出力コストの内訳
```

**価格設定ファイル例 (`config/pricing.json`):**
```json
{
  "gemini-2.5-pro": {
    "input_token_price_per_1m": 1.25,
    "output_token_price_per_1m": 5.00,
    "currency": "USD",
    "exchange_rate": 150.0
  },
  "gpt-4o": {
    "input_token_price_per_1m": 2.50,
    "output_token_price_per_1m": 10.00,
    "currency": "USD",
    "exchange_rate": 150.0
  }
}
```

---

### 3.4. ユーティリティモジュール (`utils/`)

#### Logger (`logger.py`)
```python
class ExperimentLogger:
    def __init__(self, log_dir: str)

    def log_request(self, model: str, pdf_name: str, timestamp: str)
    def log_response(self, model: str, pdf_name: str, response_time: float, tokens: dict)
    def log_error(self, model: str, pdf_name: str, error: Exception)
    def log_evaluation(self, model: str, pdf_name: str, metrics: dict)
    def save_to_csv(self, output_path: str)
    def generate_summary_report(self) -> dict
```

**ログ項目:**
- タイムスタンプ
- モデル名
- PDF名
- API応答時間
- 入力トークン数
- 出力トークン数
- コスト（円）
- 項目正答率
- F1スコア
- 完全一致（True/False）
- スキーマ準拠（True/False）
- エラーメッセージ
- 特記事項

#### ConfigLoader (`config_loader.py`)
```python
class ConfigLoader:
    def load_api_keys(self) -> dict
    def load_pricing(self) -> dict
    def load_schema(self) -> dict
    def load_system_prompt(self) -> str
    def validate_config(self) -> bool
```

---

### 3.5. メイン実行スクリプト (`main.py`)

#### 実行フロー
```python
def main():
    # 1. 設定読み込み
    config = ConfigLoader()
    api_keys = config.load_api_keys()
    pricing = config.load_pricing()
    schema = config.load_schema()
    system_prompt = config.load_system_prompt()

    # 2. ログ初期化
    logger = ExperimentLogger("output/logs")

    # 3. PDF一覧取得
    pdf_files = glob("data/input/*.pdf")

    # 4. LLMクライアント初期化
    clients = {
        "gemini-pro": GeminiClient(api_keys["gemini"], "gemini-2.5-pro"),
        "gemini-flash": GeminiClient(api_keys["gemini"], "gemini-2.5-flash"),
        "gpt-4o": GPTClient(api_keys["openai"], "gpt-4o"),
        "claude-opus": ClaudeClient(api_keys["anthropic"], "claude-3-opus"),
        "claude-sonnet": ClaudeClient(api_keys["anthropic"], "claude-3-sonnet"),
        "azure-doc": AzureDocumentClient(api_keys["azure"])
    }

    # 5. 実験実行
    for pdf_path in pdf_files:
        pdf_name = Path(pdf_path).stem
        golden_data = load_json(f"data/golden/{pdf_name}.json")

        for model_name, client in clients.items():
            try:
                # 5.1 データ抽出
                start_time = time.time()
                extracted_data = client.extract_data(pdf_path, system_prompt, schema)
                response_time = time.time() - start_time

                # 5.2 結果保存
                save_json(extracted_data, f"output/extracted/{model_name}_{pdf_name}.json")

                # 5.3 トークン・コスト記録
                tokens = client.get_token_usage()
                cost = CostCalculator(pricing).calculate_cost(model_name, tokens)

                # 5.4 評価実行
                validator = SchemaValidator(schema)
                is_valid, errors = validator.validate(extracted_data)

                calculator = AccuracyCalculator(golden_data, extracted_data)
                metrics = {
                    "field_accuracy": calculator.calculate_field_accuracy(),
                    "f1_score": calculator.calculate_f1_score(),
                    "exact_match": calculator.calculate_exact_match(),
                    "schema_conformance": is_valid
                }

                # 5.5 ログ記録
                logger.log_response(model_name, pdf_name, response_time, tokens)
                logger.log_evaluation(model_name, pdf_name, metrics)

            except Exception as e:
                logger.log_error(model_name, pdf_name, e)
                continue

    # 6. 結果集計
    logger.save_to_csv("output/results/metrics.csv")
    summary = logger.generate_summary_report()
    save_json(summary, "output/results/summary.json")

    # 7. 可視化（オプション）
    generate_visualizations(summary)
```

#### コマンドライン引数
```python
parser = argparse.ArgumentParser()
parser.add_argument("--model", choices=["gemini", "gpt", "claude", "azure", "all"], default="all")
parser.add_argument("--pdf", help="特定のPDFのみ実行")
parser.add_argument("--skip-evaluation", action="store_true", help="評価をスキップ")
parser.add_argument("--dry-run", action="store_true", help="API呼び出しなしでテスト実行")
```

---

## 4. 必要なライブラリ (`requirements.txt`)

```txt
# API Clients
google-generativeai>=0.3.0
openai>=1.0.0
anthropic>=0.18.0
azure-ai-formrecognizer>=3.3.0

# PDF Processing
pdf2image>=1.16.0
Pillow>=10.0.0
PyPDF2>=3.0.0

# Data Validation & Processing
jsonschema>=4.17.0
pydantic>=2.0.0

# Utilities
python-dotenv>=1.0.0
requests>=2.31.0
tqdm>=4.65.0

# Data Analysis & Visualization (Optional)
pandas>=2.0.0
matplotlib>=3.7.0
seaborn>=0.12.0

# Testing
pytest>=7.3.0
pytest-cov>=4.1.0
```

---

## 5. セキュリティ要件

### APIキーの管理
- `config/api_keys.json`は`.gitignore`に追加
- 環境変数からの読み込みをサポート
- サンプル設定ファイル`api_keys.example.json`を用意

### データ保護
- 正解データ（Golden Standard）は暗号化推奨
- 実験結果に個人情報が含まれないよう注意

---

## 6. エラーハンドリング要件

### API関連エラー
- **レート制限**: 指数バックオフでリトライ（最大5回）
- **タイムアウト**: 60秒でタイムアウト、エラーログ記録
- **認証エラー**: 即座に停止、エラーメッセージ表示
- **JSONパースエラー**: 生のレスポンスを保存、ログ記録

### データ処理エラー
- **PDF読み込みエラー**: スキップして次へ、ログ記録
- **画像変換エラー**: 解像度を下げて再試行
- **スキーマ検証エラー**: 詳細なエラー内容を記録

---

## 7. パフォーマンス要件

### 並列処理
- 同一モデル内での並列処理は避ける（レート制限対策）
- 異なるモデル間での並列処理は可能（オプション）

### メモリ管理
- 大容量PDFの処理時にメモリ使用量を監視
- 画像変換時の解像度を調整可能に

### 進捗表示
- `tqdm`を使用したプログレスバー表示
- 現在処理中のモデル・PDF名を表示
- 推定残り時間の表示

---

## 8. テスト要件

### ユニットテスト
- 各モジュールの単体テスト
- モックAPIレスポンスを使用したテスト

### 統合テスト
- サンプルPDFを使用したエンドツーエンドテスト
- 評価ロジックの検証

### テストケース
```python
# tests/test_accuracy_calculator.py
def test_calculate_field_accuracy():
    golden = {"name": "田中太郎", "age": 30}
    extracted = {"name": "田中太郎", "age": 31}
    calculator = AccuracyCalculator(golden, extracted)
    assert calculator.calculate_field_accuracy() == 0.5

# tests/test_schema_validator.py
def test_schema_validation():
    validator = SchemaValidator("config/schema.json")
    valid_json = {...}
    is_valid, errors = validator.validate(valid_json)
    assert is_valid == True
```

---

## 9. 出力形式

### メトリクスCSV (`output/results/metrics.csv`)
```csv
model,pdf_name,response_time,input_tokens,output_tokens,cost_jpy,field_accuracy,f1_score,exact_match,schema_conformance,error_message,notes
gemini-pro,pdf_01,2.35,12450,3200,125.5,0.92,0.89,False,True,,
gpt-4o,pdf_01,3.12,13200,3450,187.3,0.95,0.93,False,True,,
```

### サマリーJSON (`output/results/summary.json`)
```json
{
  "experiment_date": "2025-01-15",
  "total_pdfs": 20,
  "models": {
    "gemini-pro": {
      "avg_field_accuracy": 0.91,
      "avg_f1_score": 0.88,
      "exact_match_rate": 0.15,
      "schema_conformance_rate": 0.95,
      "avg_cost_per_pdf": 125.5,
      "avg_response_time": 2.45,
      "total_cost": 2510.0
    }
  }
}
```

---

## 10. 今後の拡張性

### Phase 2 機能
- ダッシュボードでのリアルタイム監視
- 自動レポート生成（PDF/HTML）
- A/Bテスト機能（プロンプトの比較）
- ファインチューニング用データセット生成

### Phase 3 機能
- Web UI（Streamlit/Gradio）
- データベース連携（結果の永続化）
- CI/CD統合（自動実験実行）
