# 契約管理APP システム設計書

最終更新: 2025-12-17 (JST)
作成者: 村松亮、Claude Code

**更新履歴:**
- 2025-12-17: Next.js 15への更新、API実装状況の反映
- 2025-10-05: 初版作成

---

## 1. システム概要

### 1.1 システムアーキテクチャ

本システムは、Next.js (App Router) をベースとした **モダンWebアプリケーション** として構築します。

#### 1.1.1 全体構成
```
┌─────────────────────────────────────────────────────────┐
│                     ユーザー (Browser)                    │
└─────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────┐
│              Next.js Application (App Router)            │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Frontend (React + TypeScript)                   │   │
│  │  - Pages (App Router)                            │   │
│  │  - Components                                     │   │
│  │  - State Management (Zustand)                    │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Backend (API Routes / Server Actions)           │   │
│  │  - API Routes (/api/*)                           │   │
│  │  - Server Actions                                │   │
│  │  - Database Access (Prisma)                      │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                            │
            ┌───────────────┼───────────────┐
            ↓               ↓               ↓
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │  PostgreSQL  │ │  AWS S3      │ │  External    │
    │  (Database)  │ │  (Storage)   │ │  APIs        │
    └──────────────┘ └──────────────┘ └──────────────┘
                                       - Amazon Textract
                                       - OpenAI/Claude API
```

#### 1.1.2 技術スタック

**フロントエンド:**
- **Framework**: Next.js 15+ (App Router with Turbopack)
- **Language**: TypeScript 5+
- **UI Library**: React 19+
- **Styling**: Tailwind CSS 3+ / CSS Modules
- **State Management**: Zustand
- **Form Handling**: React Hook Form + Zod
- **Date Formatting**: date-fns
- **Number Formatting**: Intl.NumberFormat (標準API)
- **HTTP Client**: fetch API (Next.js組み込み)
- **PDF Viewer**: react-pdf または PDF.js

**バックエンド:**
- **Framework**: Next.js API Routes + Server Actions
- **Language**: TypeScript 5+
- **ORM**: Prisma
- **Authentication**: NextAuth.js (Auth.js)
- **Validation**: Zod

**データベース:**
- **RDBMS**: PostgreSQL 15+
- **Hosting**: AWS RDS / Vercel Postgres / Supabase

**ファイルストレージ:**
- **Object Storage**: AWS S3 / Vercel Blob Storage

**外部サービス:**
- **OCR**: Amazon Textract
- **LLM**: OpenAI API (GPT-4) / Anthropic Claude API
- **Email**: AWS SES / SendGrid

**インフラ・デプロイ:**
- **Hosting**: Vercel / AWS (ECS + ALB)
- **CI/CD**: GitHub Actions
- **Monitoring**: Vercel Analytics / Sentry

---

## 2. ディレクトリ構成

```
contract-manage-demo-next/
├── prisma/
│   ├── schema.prisma          # Prismaスキーマ定義
│   └── migrations/            # マイグレーションファイル
├── public/
│   └── images/                # 静的画像ファイル
├── src/
│   ├── app/                   # Next.js App Router
│   │   ├── (auth)/
│   │   │   └── login/
│   │   │       └── page.tsx   # ログイン画面
│   │   ├── (dashboard)/
│   │   │   ├── layout.tsx     # 共通レイアウト
│   │   │   ├── dashboard/
│   │   │   │   └── page.tsx   # ダッシュボード
│   │   │   ├── upload/
│   │   │   │   └── page.tsx   # 契約書登録
│   │   │   ├── contracts/
│   │   │   │   ├── page.tsx           # 契約検索
│   │   │   │   ├── [id]/page.tsx     # 契約詳細
│   │   │   │   └── [id]/verify/page.tsx # 検証画面
│   │   │   ├── rentroll/
│   │   │   │   └── page.tsx   # レントロール作成
│   │   │   ├── analysis/
│   │   │   │   └── page.tsx   # AI契約分析
│   │   │   └── calendar/
│   │   │       └── page.tsx   # 期限管理
│   │   ├── api/               # API Routes
│   │   │   ├── auth/
│   │   │   │   └── [...nextauth]/route.ts
│   │   │   ├── contracts/
│   │   │   │   ├── route.ts           # 契約一覧・作成
│   │   │   │   ├── [id]/route.ts     # 契約詳細・更新・削除
│   │   │   │   └── search/route.ts   # 契約検索
│   │   │   ├── upload/
│   │   │   │   ├── route.ts           # ファイルアップロード
│   │   │   │   └── status/route.ts   # 処理状況取得
│   │   │   ├── ocr/
│   │   │   │   └── route.ts           # OCR処理
│   │   │   ├── extraction/
│   │   │   │   └── route.ts           # LLM抽出
│   │   │   ├── rag/
│   │   │   │   └── route.ts           # RAG検索
│   │   │   ├── analysis/
│   │   │   │   └── route.ts           # AI分析
│   │   │   └── rentroll/
│   │   │       └── route.ts           # レントロール生成
│   │   ├── layout.tsx         # ルートレイアウト
│   │   └── globals.css        # グローバルスタイル
│   ├── components/            # Reactコンポーネント
│   │   ├── ui/                # 共通UIコンポーネント
│   │   │   ├── Button.tsx
│   │   │   ├── Card.tsx
│   │   │   ├── Input.tsx
│   │   │   ├── Select.tsx
│   │   │   ├── Table.tsx
│   │   │   ├── Badge.tsx
│   │   │   ├── ProgressBar.tsx
│   │   │   └── Modal.tsx
│   │   ├── layout/            # レイアウトコンポーネント
│   │   │   ├── Header.tsx
│   │   │   ├── Sidebar.tsx
│   │   │   └── DashboardLayout.tsx
│   │   ├── contracts/         # 契約関連コンポーネント
│   │   │   ├── ContractList.tsx
│   │   │   ├── ContractCard.tsx
│   │   │   ├── ContractDetail.tsx
│   │   │   ├── ContractSearchForm.tsx
│   │   │   └── ContractVerificationForm.tsx
│   │   ├── upload/            # アップロード関連
│   │   │   ├── DropZone.tsx
│   │   │   ├── FileUploadProgress.tsx
│   │   │   └── ProcessingStatus.tsx
│   │   ├── calendar/          # カレンダー関連
│   │   │   ├── Calendar.tsx
│   │   │   └── EventList.tsx
│   │   └── analysis/          # 分析関連
│   │       ├── AnalysisChat.tsx
│   │       └── AnalysisResult.tsx
│   ├── lib/                   # ユーティリティ・ライブラリ
│   │   ├── prisma.ts          # Prismaクライアント
│   │   ├── auth.ts            # 認証設定
│   │   ├── s3.ts              # S3クライアント
│   │   ├── textract.ts        # Textractクライアント
│   │   ├── openai.ts          # OpenAI APIクライアント
│   │   ├── claude.ts          # Claude APIクライアント
│   │   ├── email.ts           # メール送信
│   │   └── utils.ts           # 汎用ユーティリティ
│   ├── services/              # ビジネスロジック
│   │   ├── contractService.ts      # 契約管理
│   │   ├── uploadService.ts        # アップロード処理
│   │   ├── ocrService.ts           # OCR処理
│   │   ├── extractionService.ts    # LLM抽出
│   │   ├── ragService.ts           # RAG検索
│   │   ├── analysisService.ts      # AI分析
│   │   ├── rentrollService.ts      # レントロール生成
│   │   └── notificationService.ts  # 通知サービス
│   ├── stores/                # Zustand Store
│   │   ├── authStore.ts       # 認証状態
│   │   ├── contractStore.ts   # 契約データ
│   │   └── uiStore.ts         # UI状態
│   ├── types/                 # 型定義
│   │   ├── contract.ts
│   │   ├── upload.ts
│   │   ├── user.ts
│   │   └── api.ts
│   └── schemas/               # Zodスキーマ
│       ├── contractSchema.ts
│       ├── uploadSchema.ts
│       └── userSchema.ts
├── .env.local                 # 環境変数（ローカル）
├── .env.production            # 環境変数（本番）
├── next.config.js             # Next.js設定
├── tailwind.config.js         # Tailwind CSS設定
├── tsconfig.json              # TypeScript設定
└── package.json               # 依存パッケージ
```

---

## 3. データベース設計

### 3.1 ER図

```
┌─────────────────┐         ┌─────────────────┐
│     users       │         │   contracts     │
├─────────────────┤         ├─────────────────┤
│ id (PK)         │         │ id (PK)         │
│ email           │         │ contract_number │
│ password_hash   │◄────────│ created_by (FK) │
│ name            │    1:N  │ type            │
│ role            │         │ status          │
│ created_at      │         │ verification_status│
│ updated_at      │         │ start_date      │
└─────────────────┘         │ end_date        │
                            │ pdf_url         │
        ┌───────────────────│ ...             │
        │                   └─────────────────┘
        │ 1:N                        │
        │                            │ 1:1
        ↓                            ↓
┌─────────────────┐         ┌─────────────────┐
│ contract_parties│         │ contract_details│
├─────────────────┤         ├─────────────────┤
│ id (PK)         │         │ id (PK)         │
│ contract_id(FK) │         │ contract_id(FK) │
│ party_type      │         │ property_info   │
│ name            │         │ financial_terms │
│ address         │         │ special_notes   │
│ contact         │         │ extracted_at    │
│ ...             │         │ confidence_score│
└─────────────────┘         └─────────────────┘

┌─────────────────┐         ┌─────────────────┐
│ upload_jobs     │         │ audit_logs      │
├─────────────────┤         ├─────────────────┤
│ id (PK)         │         │ id (PK)         │
│ user_id (FK)    │         │ user_id (FK)    │
│ file_name       │         │ contract_id(FK) │
│ status          │         │ action          │
│ progress        │         │ old_value       │
│ current_step    │         │ new_value       │
│ error_message   │         │ created_at      │
│ created_at      │         │ ip_address      │
└─────────────────┘         └─────────────────┘
```

### 3.2 Prismaスキーマ

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ユーザー
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  contracts     Contract[]
  uploadJobs    UploadJob[]
  auditLogs     AuditLog[]

  @@map("users")
}

enum UserRole {
  USER          // 事務担当者
  MANAGER       // マネージャー・管理者
  ACCOUNTANT    // 経理担当者
  ADMIN         // システム管理者
}

// 契約
model Contract {
  id                  String              @id @default(cuid())
  contractNumber      String              @unique @map("contract_number")
  type                ContractType
  status              ContractStatus      @default(ACTIVE)
  verificationStatus  VerificationStatus  @default(UNVERIFIED) @map("verification_status")

  // 契約期間
  startDate           DateTime            @map("start_date")
  endDate             DateTime            @map("end_date")
  renewalType         String?             @map("renewal_type")
  noticePeriodMonths  Int?                @map("notice_period_months")

  // ファイル情報
  pdfUrl              String              @map("pdf_url")
  pdfFileName         String              @map("pdf_file_name")
  pdfFileSize         Int                 @map("pdf_file_size")

  // メタデータ
  createdBy           String              @map("created_by")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  verifiedAt          DateTime?           @map("verified_at")
  verifiedBy          String?             @map("verified_by")

  // リレーション
  creator             User                @relation(fields: [createdBy], references: [id])
  details             ContractDetail?
  parties             ContractParty[]
  auditLogs           AuditLog[]

  @@index([contractNumber])
  @@index([status])
  @@index([verificationStatus])
  @@index([startDate])
  @@index([endDate])
  @@map("contracts")
}

enum ContractType {
  RENTAL            // 賃貸借契約
  RENEWAL           // 更新合意書
  MEMORANDUM        // 覚書
}

enum ContractStatus {
  ACTIVE            // 有効
  EXPIRED           // 終了
  TERMINATED        // 解約済み
}

enum VerificationStatus {
  UNVERIFIED        // 未検証
  VERIFIED          // 検証済み
  APPROVED          // 承認済み
}

// 契約詳細（物件・金銭条件）
model ContractDetail {
  id              String    @id @default(cuid())
  contractId      String    @unique @map("contract_id")

  // 物件情報
  propertyAddress String?   @map("property_address")
  propertyName    String?   @map("property_name")
  propertyArea    Float?    @map("property_area")
  propertyUsage   String?   @map("property_usage")
  roomNumber      String?   @map("room_number")

  // 金銭条件
  monthlyRent     Decimal?  @map("monthly_rent") @db.Decimal(12, 2)
  deposit         Decimal?  @map("deposit") @db.Decimal(12, 2)
  keyMoney        Decimal?  @map("key_money") @db.Decimal(12, 2)
  managementFee   Decimal?  @map("management_fee") @db.Decimal(12, 2)

  // AI抽出メタデータ
  extractedAt     DateTime? @map("extracted_at")
  confidenceScore Float?    @map("confidence_score")

  // リレーション
  contract        Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@map("contract_details")
}

// 契約当事者（貸主・借主）
model ContractParty {
  id          String      @id @default(cuid())
  contractId  String      @map("contract_id")
  partyType   PartyType   @map("party_type")

  // 当事者情報
  name        String
  nameKana    String?     @map("name_kana")
  address     String?
  phoneNumber String?     @map("phone_number")
  email       String?

  // AI抽出メタデータ
  confidenceScore Float?  @map("confidence_score")

  // リレーション
  contract    Contract    @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@map("contract_parties")
}

enum PartyType {
  LESSOR        // 貸主
  LESSEE        // 借主
}

// アップロードジョブ
model UploadJob {
  id            String          @id @default(cuid())
  userId        String          @map("user_id")
  fileName      String          @map("file_name")
  fileSize      Int             @map("file_size")
  status        UploadStatus
  progress      Int             @default(0)
  currentStep   ProcessingStep  @map("current_step")
  errorMessage  String?         @map("error_message")
  contractId    String?         @map("contract_id")

  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // リレーション
  user          User            @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("upload_jobs")
}

enum UploadStatus {
  UPLOADING
  UPLOADED
  OCR_PROCESSING
  OCR_COMPLETED
  EXTRACTING
  EXTRACTION_COMPLETED
  FAILED
  COMPLETED
}

enum ProcessingStep {
  UPLOAD
  OCR
  EXTRACTION
  VERIFICATION
}

// 監査ログ
model AuditLog {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  contractId  String?   @map("contract_id")
  action      String
  oldValue    String?   @map("old_value")
  newValue    String?   @map("new_value")
  ipAddress   String?   @map("ip_address")
  createdAt   DateTime  @default(now()) @map("created_at")

  // リレーション
  user        User      @relation(fields: [userId], references: [id])
  contract    Contract? @relation(fields: [contractId], references: [id])

  @@index([userId])
  @@index([contractId])
  @@index([createdAt])
  @@map("audit_logs")
}

// RAG検索履歴
model SearchHistory {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  query       String
  resultCount Int       @map("result_count")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@map("search_histories")
}

// AI分析履歴
model AnalysisHistory {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  question    String
  answer      String    @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@map("analysis_histories")
}
```

---

## 4. API設計

### 4.1 認証API

#### POST /api/auth/signin
- **説明**: ログイン
- **Request Body**:
  ```json
  {
    "email": "user@example.com",
    "password": "password123"
  }
  ```
- **Response**: NextAuth.jsのセッション情報

#### POST /api/auth/signout
- **説明**: ログアウト

### 4.2 契約管理API

#### GET /api/contracts
- **説明**: 契約一覧取得
- **Query Parameters**:
  - `page`: ページ番号 (default: 1)
  - `limit`: 取得件数 (default: 20)
  - `status`: 契約ステータス
  - `type`: 契約種別
  - `keyword`: キーワード検索
- **Response**:
  ```json
  {
    "data": [
      {
        "id": "契約ID",
        "contractNumber": "C-2025-001",
        "type": "RENTAL",
        "status": "ACTIVE",
        "startDate": "2025-01-01",
        "endDate": "2027-12-31",
        "propertyName": "東京オフィスビル 5F",
        "monthlyRent": 500000,
        "verificationStatus": "VERIFIED"
      }
    ],
    "total": 100,
    "page": 1,
    "totalPages": 5
  }
  ```

#### GET /api/contracts/[id]
- **説明**: 契約詳細取得
- **Response**:
  ```json
  {
    "id": "契約ID",
    "contractNumber": "C-2025-001",
    "type": "RENTAL",
    "status": "ACTIVE",
    "verificationStatus": "VERIFIED",
    "startDate": "2025-01-01",
    "endDate": "2027-12-31",
    "pdfUrl": "https://...",
    "details": {
      "propertyAddress": "東京都千代田区丸の内1-1-1",
      "propertyName": "東京オフィスビル 5F",
      "propertyArea": 120.5,
      "monthlyRent": 500000,
      "deposit": 1500000,
      "confidenceScore": 0.95
    },
    "parties": [
      {
        "partyType": "LESSOR",
        "name": "株式会社丸の内不動産",
        "address": "...",
        "phoneNumber": "...",
        "confidenceScore": 0.92
      }
    ]
  }
  ```

#### PUT /api/contracts/[id]
- **説明**: 契約更新
- **Request Body**: 契約情報

#### DELETE /api/contracts/[id]
- **説明**: 契約削除

#### POST /api/contracts/search
- **説明**: 契約検索（通常検索）
- **Request Body**:
  ```json
  {
    "keyword": "渋谷",
    "filters": {
      "type": "RENTAL",
      "status": "ACTIVE",
      "startDateFrom": "2024-01-01",
      "startDateTo": "2025-12-31",
      "minRent": 100000,
      "maxRent": 1000000
    }
  }
  ```

### 4.3 アップロード・処理API

#### POST /api/upload
- **説明**: PDFファイルアップロード
- **Request**: multipart/form-data
- **Response**:
  ```json
  {
    "jobId": "job_xxx",
    "fileName": "contract.pdf",
    "status": "UPLOADING"
  }
  ```

#### GET /api/upload/status?jobId=xxx
- **説明**: 処理状況取得
- **Response**:
  ```json
  {
    "jobId": "job_xxx",
    "status": "OCR_PROCESSING",
    "progress": 45,
    "currentStep": "OCR",
    "fileName": "contract.pdf"
  }
  ```

#### POST /api/ocr
- **説明**: OCR処理実行（内部API）
- **Request Body**:
  ```json
  {
    "jobId": "job_xxx",
    "pdfUrl": "s3://..."
  }
  ```

#### POST /api/extraction
- **説明**: LLM情報抽出（内部API）
- **Request Body**:
  ```json
  {
    "jobId": "job_xxx",
    "ocrText": "..."
  }
  ```

### 4.4 RAG検索API

#### POST /api/rag
- **説明**: RAG検索
- **Request Body**:
  ```json
  {
    "query": "来年3月末に満了する賃貸契約を教えて"
  }
  ```
- **Response**:
  ```json
  {
    "answer": "2026年3月末（2026-03-31）に満了する賃貸契約は5件見つかりました...",
    "contracts": [
      {
        "id": "...",
        "contractNumber": "C-2024-089",
        "relevanceScore": 0.98,
        "propertyName": "渋谷店舗 1F",
        "endDate": "2026-03-31"
      }
    ]
  }
  ```

### 4.5 AI分析API

#### POST /api/analysis
- **説明**: AI契約分析
- **Request Body**:
  ```json
  {
    "question": "A社がオーナーの物件の、一店舗あたりの賃料平均を計算して"
  }
  ```
- **Response**:
  ```json
  {
    "answer": "A社がオーナーの物件は23件あり、平均賃料は¥584,348です。",
    "statistics": {
      "count": 23,
      "averageRent": 584348,
      "totalRent": 13440000
    },
    "contracts": [...]
  }
  ```

### 4.6 レントロール生成API

#### POST /api/rentroll
- **説明**: レントロール生成
- **Request Body**:
  ```json
  {
    "filters": {
      "startDate": "2025-01-01",
      "endDate": "2025-12-31",
      "statuses": ["ACTIVE"],
      "types": ["RENTAL"]
    },
    "fields": ["contractNumber", "propertyName", "monthlyRent", ...],
    "sortBy": "contractNumber",
    "format": "xlsx"
  }
  ```
- **Response**:
  ```json
  {
    "downloadUrl": "https://...",
    "fileName": "rentroll_20251005.xlsx",
    "recordCount": 987
  }
  ```

---

## 5. 主要機能の実装方針

### 5.1 認証・認可

**実装方法**: NextAuth.js (Auth.js v5)

```typescript
// src/lib/auth.ts
import NextAuth from "next-auth"
import CredentialsProvider from "next-auth/providers/credentials"
import { PrismaAdapter } from "@auth/prisma-adapter"
import { prisma } from "@/lib/prisma"
import bcrypt from "bcryptjs"

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: PrismaAdapter(prisma),
  providers: [
    CredentialsProvider({
      name: "Credentials",
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        const user = await prisma.user.findUnique({
          where: { email: credentials.email }
        })

        if (!user) return null

        const isValid = await bcrypt.compare(
          credentials.password,
          user.passwordHash
        )

        if (!isValid) return null

        return {
          id: user.id,
          email: user.email,
          name: user.name,
          role: user.role
        }
      }
    })
  ],
  session: {
    strategy: "jwt"
  },
  pages: {
    signIn: "/login"
  }
})
```

### 5.2 ファイルアップロード

**実装方法**: AWS S3 + Presigned URL

```typescript
// src/lib/s3.ts
import { S3Client, PutObjectCommand } from "@aws-sdk/client-s3"
import { getSignedUrl } from "@aws-sdk/s3-request-presigner"

const s3Client = new S3Client({
  region: process.env.AWS_REGION!,
  credentials: {
    accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!
  }
})

export async function generateUploadUrl(fileName: string) {
  const key = `contracts/${Date.now()}-${fileName}`

  const command = new PutObjectCommand({
    Bucket: process.env.AWS_S3_BUCKET!,
    Key: key,
    ContentType: "application/pdf"
  })

  const uploadUrl = await getSignedUrl(s3Client, command, { expiresIn: 3600 })

  return { uploadUrl, key }
}
```

**クライアント側実装**:
```typescript
// src/components/upload/DropZone.tsx
async function handleFileUpload(file: File) {
  // 1. サーバーからPresigned URL取得
  const { uploadUrl, key } = await fetch("/api/upload/presigned", {
    method: "POST",
    body: JSON.stringify({ fileName: file.name })
  }).then(r => r.json())

  // 2. S3に直接アップロード
  await fetch(uploadUrl, {
    method: "PUT",
    body: file,
    headers: { "Content-Type": "application/pdf" }
  })

  // 3. ジョブ作成
  const job = await fetch("/api/upload", {
    method: "POST",
    body: JSON.stringify({ fileName: file.name, s3Key: key })
  }).then(r => r.json())

  // 4. ポーリングで処理状況監視
  pollJobStatus(job.jobId)
}
```

### 5.3 OCR処理

**実装方法**: Amazon Textract

```typescript
// src/lib/textract.ts
import { TextractClient, DetectDocumentTextCommand } from "@aws-sdk/client-textract"

const textractClient = new TextractClient({
  region: process.env.AWS_REGION!
})

export async function extractTextFromPDF(s3Key: string) {
  const command = new DetectDocumentTextCommand({
    Document: {
      S3Object: {
        Bucket: process.env.AWS_S3_BUCKET!,
        Name: s3Key
      }
    }
  })

  const response = await textractClient.send(command)

  // テキスト抽出
  const lines = response.Blocks?.filter(block => block.BlockType === "LINE")
    .map(block => block.Text)
    .join("\n") || ""

  return lines
}
```

### 5.4 LLM情報抽出

**実装方法**: OpenAI API (GPT-4)

```typescript
// src/lib/openai.ts
import OpenAI from "openai"

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY!
})

export async function extractContractInfo(ocrText: string) {
  const prompt = `
以下の契約書テキストから、構造化されたJSON形式で契約情報を抽出してください。

【抽出項目】
- 契約種別（RENTAL/RENEWAL/MEMORANDUM）
- 契約番号
- 契約期間（開始日、終了日）
- 物件情報（住所、名称、面積、用途）
- 当事者情報（貸主、借主の名前、住所、連絡先）
- 金銭条件（賃料、敷金、礼金、共益費）
- 更新条件、解約条件

【契約書テキスト】
${ocrText}
`

  const response = await openai.chat.completions.create({
    model: "gpt-4-turbo",
    messages: [
      { role: "system", content: "あなたは不動産契約書の情報抽出の専門家です。" },
      { role: "user", content: prompt }
    ],
    response_format: { type: "json_object" },
    temperature: 0
  })

  const extracted = JSON.parse(response.choices[0].message.content!)

  return extracted
}
```

### 5.5 RAG検索

**実装方法**: OpenAI Embeddings + PostgreSQL (pgvector)

```typescript
// prisma/schema.prismaに追加
model ContractEmbedding {
  id          String   @id @default(cuid())
  contractId  String   @unique @map("contract_id")
  embedding   Unsupported("vector(1536)") // pgvector
  content     String   @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  contract    Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@map("contract_embeddings")
}
```

```typescript
// src/services/ragService.ts
import { openai } from "@/lib/openai"
import { prisma } from "@/lib/prisma"

export async function searchContracts(query: string) {
  // 1. クエリをEmbedding化
  const embeddingResponse = await openai.embeddings.create({
    model: "text-embedding-3-small",
    input: query
  })
  const queryEmbedding = embeddingResponse.data[0].embedding

  // 2. ベクトル類似度検索
  const results = await prisma.$queryRaw`
    SELECT
      c.*,
      ce.content,
      1 - (ce.embedding <=> ${queryEmbedding}::vector) as similarity
    FROM contracts c
    JOIN contract_embeddings ce ON ce.contract_id = c.id
    ORDER BY ce.embedding <=> ${queryEmbedding}::vector
    LIMIT 10
  `

  // 3. LLMで回答生成
  const context = results.map(r => r.content).join("\n\n")
  const answerResponse = await openai.chat.completions.create({
    model: "gpt-4-turbo",
    messages: [
      { role: "system", content: "契約管理システムのAIアシスタントです。" },
      { role: "user", content: `以下の契約情報から質問に答えてください。\n\n【質問】\n${query}\n\n【契約情報】\n${context}` }
    ]
  })

  return {
    answer: answerResponse.choices[0].message.content,
    contracts: results
  }
}
```

### 5.6 リアルタイム処理状況更新

**実装方法**: Server-Sent Events (SSE) または Polling

```typescript
// src/app/api/upload/status/route.ts
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const jobId = searchParams.get("jobId")

  const job = await prisma.uploadJob.findUnique({
    where: { id: jobId }
  })

  return Response.json(job)
}

// クライアント側（Polling）
function useJobStatus(jobId: string) {
  const [status, setStatus] = useState<UploadJob | null>(null)

  useEffect(() => {
    const interval = setInterval(async () => {
      const response = await fetch(`/api/upload/status?jobId=${jobId}`)
      const data = await response.json()
      setStatus(data)

      if (data.status === "COMPLETED" || data.status === "FAILED") {
        clearInterval(interval)
      }
    }, 2000)

    return () => clearInterval(interval)
  }, [jobId])

  return status
}
```

---

## 6. セキュリティ実装

### 6.1 パスワードハッシュ化

```typescript
import bcrypt from "bcryptjs"

// ユーザー登録時
const passwordHash = await bcrypt.hash(password, 12)

// ログイン時
const isValid = await bcrypt.compare(password, user.passwordHash)
```

### 6.2 CSRF対策

Next.js + NextAuth.jsが自動的にCSRFトークンを管理

### 6.3 SQLインジェクション対策

Prismaのパラメータ化されたクエリを使用

### 6.4 XSS対策

Reactの自動エスケープを活用

### 6.5 認可チェック

```typescript
// src/lib/auth.ts
export async function requireAuth() {
  const session = await auth()
  if (!session) {
    redirect("/login")
  }
  return session
}

export async function requireRole(role: UserRole) {
  const session = await requireAuth()
  if (session.user.role !== role) {
    throw new Error("Unauthorized")
  }
  return session
}
```

---

## 7. デプロイ・インフラ

### 7.1 Vercelデプロイ

**推奨構成**:
- **Hosting**: Vercel
- **Database**: Vercel Postgres (Neon)
- **Storage**: Vercel Blob Storage
- **Environment Variables**: Vercelダッシュボードで設定

**デプロイコマンド**:
```bash
vercel deploy --prod
```

### 7.2 AWS ECSデプロイ（代替案）

**構成**:
- **Compute**: ECS Fargate
- **Load Balancer**: ALB
- **Database**: RDS PostgreSQL
- **Storage**: S3

---

## 8. 開発・運用

### 8.1 ローカル開発環境

```bash
# 依存パッケージインストール
npm install

# 環境変数設定
cp .env.example .env.local

# データベースマイグレーション
npx prisma migrate dev

# 開発サーバー起動
npm run dev
```

### 8.2 テスト

```bash
# ユニットテスト
npm run test

# E2Eテスト
npm run test:e2e
```

### 8.3 CI/CD

GitHub Actionsで自動デプロイ

```yaml
# .github/workflows/deploy.yml
name: Deploy
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm run build
      - run: npx prisma migrate deploy
      - uses: amondnet/vercel-action@v20
```

---

## 9. 今後の拡張

- ベクトルDBの導入（Pinecone / Weaviate）
- WebSocket対応（リアルタイム通知）
- バッチ処理の実装（期限アラート自動送信）
- モバイルアプリ化（React Native）
