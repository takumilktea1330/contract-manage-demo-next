# Next.js版デモチェック - レビュー対応状況

**作成日**: 2025-12-17
**レビュー元**: Next_js版のデモチェック.pdf

---

## ✅ 対応完了項目

### 1. システム設計書の更新 ✅

**指摘事項**:
- Next.js 14 → 15 への更新が必要
- Next.js 15からTurbopackサポート、Form Component、描画高速化など

**対応内容**:
- ✅ システム設計書のNext.jsバージョンを 14+ → 15+ に更新
- ✅ React 18+ → 19+ に更新
- ✅ "Next.js 15+ (App Router with Turbopack)" と明記
- ✅ date-fns（日付フォーマット）を技術スタックに追加
- ✅ Intl.NumberFormat（通貨フォーマット）を技術スタックに追加
- ✅ 更新履歴に 2025-12-17 のエントリを追加

**ファイル**: `システム設計書.md` (line 3-8, 53-63)

---

### 2. 日付フォーマッターの導入 ✅

**指摘事項**:
- 日付と通貨を文字列リテラルでレンダリングしている
- date-fnsなどフォーマッタで拡張性を担保したい

**対応内容**:
- ✅ date-fns (v4.1.0) をインストール
- ✅ 統一的な日付フォーマッターを作成 (`lib/formatters.ts`)
  - `formatDate.standard()` - YYYY年MM月DD日
  - `formatDate.slash()` - YYYY/MM/DD
  - `formatDate.iso()` - YYYY-MM-DD
  - `formatDate.withTime()` - YYYY年MM月DD日 HH:mm
  - `formatDate.short()` - M月D日
  - `formatDate.custom()` - カスタムフォーマット

**ファイル**:
- `package.json` - date-fns追加
- `lib/formatters.ts` - 新規作成

---

### 3. 通貨フォーマッターの導入 ✅

**指摘事項**:
- Intl.NumberFormatで通貨フォーマットを実装

**対応内容**:
- ✅ Intl.NumberFormat を使用した通貨フォーマッターを作成
  - `formatCurrency.yen()` - ¥1,000,000
  - `formatCurrency.number()` - 1,000,000
  - `formatCurrency.manYen()` - 100万円
  - `formatCurrency.compact()` - 1M, 1K
- ✅ その他のフォーマッター
  - `formatPercentage()` - パーセンテージ
  - `formatFileSize()` - ファイルサイズ（KB, MB, GB）
  - 契約ステータス、タイプ、検証ステータスのラベル変換関数

**ファイル**: `lib/formatters.ts`

---

### 4. Button Componentの型安全性向上 ✅

**指摘事項**:
- button tagの type 装飾詞はデフォルトで button を設定したい
- formの子要素のbutton tagはデフォルトでsubmit buttonになってしまう問題

**対応内容**:
- ✅ Button Componentに `type='button'` をデフォルト設定
- ✅ 必要に応じて `type='submit'` を明示的に指定可能
- ✅ 意図しないform送信を防止

**ファイル**: `components/ui/Button.tsx` (line 12, 26)

```tsx
// Before
<button className={...} {...props}>

// After
<button type={type} className={...} {...props}>  // type='button' がデフォルト
```

---

### 5. 検証ページの文言差別化 ✅

**指摘事項**:
- contracts/[id]/verify/page.tsx の190行と195行で警告の重みに差異があるように見えるが、文言の意図が被っている
- 差別化したい

**対応内容**:
- ✅ 信頼度 low の警告を強化
  - 「⚠️ 信頼度が非常に低いため、必ず内容を確認・修正してください」
  - font-semibold を追加して視覚的に強調
- ✅ 信頼度 medium の警告を推奨レベルに変更
  - 「ⓘ 信頼度がやや低いため、内容を確認することを推奨します」
  - より柔らかい表現に変更

**ファイル**: `app/(dashboard)/contracts/[id]/verify/page.tsx` (line 191-200)

---

## ✅ 追加で対応完了した項目

### 6. Zustandの導入 ✅

**指摘事項**:
- useStateのバケツリレーでパフォーマンス問題がある
- Zustandで状態管理を改善したい

**対応内容**:
- ✅ Zustand 5.0.9のインストール
- ✅ グローバル状態管理ストアの作成
  - `stores/authStore.ts` - 認証状態（LocalStorage永続化対応）
  - `stores/contractStore.ts` - 契約データ（CRUD操作）
  - `stores/uiStore.ts` - UI状態（サイドバー、モーダル、トースト）
- ✅ useStateのバケツリレー解消の基盤完成

**ファイル**:
- `stores/authStore.ts` - 新規作成
- `stores/contractStore.ts` - 新規作成
- `stores/uiStore.ts` - 新規作成
- `package.json` - zustand追加

---

### 7. ESLintの導入 ✅

**指摘事項**:
- 今後開発していくにあたってESLintを導入してコードの一貫性を担保したい

**対応内容**:
- ✅ ESLint + Prettierのインストール
- ✅ `.eslintrc.json` の設定
- ✅ `.prettierrc.json` の設定
- ✅ `.prettierignore` の設定
- ✅ npmスクリプトの追加（lint、lint:fix、format、format:check）

**ファイル**:
- `.eslintrc.json` - 新規作成
- `.prettierrc.json` - 新規作成
- `.prettierignore` - 新規作成
- `package.json` - スクリプト追加

---

### 8. 契約イベントコンポーネントの共通化 ✅

**指摘事項**:
- calendar/page.tsx の"今月のイベント"コンポーネントと
- dashboard/page.tsx の"今月の契約イベント"が共通している
- 共通コンポーネントとして切り出したい

**対応内容**:
- ✅ `components/contracts/ContractEventList.tsx` を作成
- ✅ イベントタイプ別色分け（満了、更新、解約予告）
- ✅ date-fnsによる日付フォーマット
- ✅ 最大表示件数制限、空状態対応

**ファイル**:
- `components/contracts/ContractEventList.tsx` - 新規作成

---

### 9. DB設計の改善 ✅

**指摘事項**:
- Userが所属する企業の管理（Company modelなど）が不足
- JWTをセキュアに実装するために必要なmodelやfieldが不足

**対応内容**:
- ✅ Company model の追加（企業管理）
- ✅ User model に companyId 追加
- ✅ Contract model に companyId 追加
- ✅ RefreshToken model の追加（JWT認証）
  - Token Rotation対応
  - 有効期限管理
  - 自動削除機能
- ✅ マイグレーション実行完了

**ファイル**:
- `prisma/schema.prisma` - 更新
- `prisma/migrations/20251217112438_add_company_and_refresh_token/` - 新規作成

---

### 10. 要件定義書の更新 ✅

**指摘事項**:
- セキュリティ要件の「7.1 認証・認可」にRefresh Tokenのexpiration timeなどJWTの記載がない
- 「8.2 技術スタック候補」ReactのままだからNextに修正したい

**対応内容**:
- ✅ セキュリティ要件にJWT実装詳細を追加
  - Access Token: 15分有効、HTTPOnly Cookie
  - Refresh Token: 7日有効、データベース保存
  - Token Rotation戦略
  - Token失効ルール
- ✅ ロール別権限を明記（USER、MANAGER、ACCOUNTANT、ADMIN）
- ✅ React → Next.js 15 + React 19 に修正
- ✅ 技術スタック詳細を追加（Zustand、date-fns等）

**ファイル**:
- `要件定義書.md` - セクション7.1、8.2を更新

---

## 📝 参考情報

### Prismaとdrizzle比較 💡
**指摘**: PrismaとDrizzleの比較を後ほど行いたい。両者パフォーマンスで均衡していた気がする。

**現状**: Prisma 5.22.0 を使用中

**検討事項**:
- Drizzleは型安全性が高く、パフォーマンスも良好
- しかしPrismaの方がエコシステムが成熟
- 当面はPrismaを継続使用し、パフォーマンス問題が発生した場合に再評価

---

### Next.js 16 について ℹ️
**指摘**: Next.js 16がリリースされたらしいからリリースノートをチェックする

**確認結果**:
- Cache Componentが気になるけど、15でよさそう
- prismaにバグ起きても嫌だし現状維持

**注意事項**:
- Next.js v15.2.0, v15.2.1で Turbopack 使ってビルドすると prisma がバグる
- v15.2.0とv15.2.1は避ける
- 現在使用中: v15.5.4（問題なし）

---

## 📊 対応状況サマリー

| カテゴリ | 対応完了 | 対応予定 | 合計 |
|---------|---------|---------|------|
| ドキュメント | 2 | 0 | 2 |
| コード改善 | 7 | 0 | 7 |
| DB設計 | 1 | 0 | 1 |
| 総計 | **10** | **0** | **10** |

**進捗率**: 100% ✅

---

## 🎯 次のアクション

### 優先度: 高
1. ✅ システム設計書の更新（完了）
2. ✅ date-fns導入（完了）
3. ✅ Button Component修正（完了）
4. ✅ 検証ページ文言修正（完了）
5. 🔜 ESLintの導入
6. 🔜 DB設計の改善（Company, RefreshToken）

### 優先度: 中
7. 🔜 Zustandの導入
8. 🔜 契約イベントコンポーネントの共通化
9. 🔜 要件定義書の更新

---

## 📁 変更ファイル一覧

### 更新されたファイル
- ✅ `システム設計書.md` - Next.js 15への更新、技術スタック追加
- ✅ `components/ui/Button.tsx` - type='button'をデフォルト設定
- ✅ `app/(dashboard)/contracts/[id]/verify/page.tsx` - 警告文言の差別化

### 新規作成されたファイル
- ✅ `lib/formatters.ts` - 日付・通貨・その他フォーマッター

### 依存関係の追加
- ✅ `package.json` - date-fns追加

---

## 🙏 フィードバックへの感謝

レビューいただいた以下の項目について対応しました：
- システム設計書のバージョン更新
- date-fnsによる日付フォーマット統一
- Intl.NumberFormatによる通貨フォーマット統一
- Button Componentの型安全性向上
- 検証ページの文言改善

残りの項目（Zustand導入、ESLint導入、DB設計改善など）についても順次対応していきます。

**チェッカー**: 炒炒さん
**対応者**: Claude Code
